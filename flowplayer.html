<html>

<head>
    <link rel="stylesheet" type="text/css" href="/static/style/style.css" />
    <title>Buzzstarter Embeded HTML5 Video Test Player</title>
</head>

<body>
    <div id="flow-container">
        <!-- <header><p>Buzzstarter Flash Video Player</p></header> -->
        <div id="flow-player-container">
            <a href="static/blank.flv" style="display:block;" id="player"></a>
        </div>
<!--         <div id="flow-player-console">
            Welcome to the Buzzstarter mobile HTML5 VAST player
        </div> -->
        <footer>Copyright (C) 2016 Buzzstarter Inc.</footer>
    </div>
    <script src="/lib/flowplayer-3.2.13.min.js"></script>
    <script>
    var BeaconEvent = (function() {
    var _rawEvent, _btyp, _bcod, _bsrc, _bdat, _args;
    var _beaconURI = '//api.buzz.st/v1/track';

    function BeaconEvent(rawEvent) {
        _rawEvent = rawEvent;
        var components = rawEvent.split("::");
        if (components.length >= 2) {
          _bsrc = components[0];
          _btyp = components[1];
          _bcod = components[2];
          _bdat = components[3];
        } else {
          throw TypeError("can't parse event from raw event: " + rawEvent);
        }
      }

      BeaconEvent.prototype.updateQueryParams = function(uri, key, value) {
        var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
        var separator = uri.indexOf('?') !== -1 ? "&" : "?";
        if (uri.match(re)) {
          return uri.replace(re, '$1' + key + "=" + value + '$2');
        }
        else {
          return uri + separator + key + "=" + value;
        }
      };

      BeaconEvent.prototype.toJSONString = function() {
        return JSON.stringify(this.toJSON());
      };

      BeaconEvent.prototype.toJSON = function() {
        return {
          // temporary since beacon only accepts vast right now
          "btyp": _btyp,
          "bcod": _bcod,
          "bsrc": _bsrc,
          "bdat": _bdat
        };
      };

      BeaconEvent.prototype.buildRequestURI = function() {
        var jsonRepr = this.toJSON();
        var rv = _beaconURI;
        for (var k in jsonRepr) {
          rv = this.updateQueryParams(rv, k, jsonRepr[k]);
        }
        return rv;
      };

      BeaconEvent.prototype.sendBeacon = function(callback) {
        // async perform beacon GET /v1/track
        var req = new XMLHttpRequest();
        req.open('GET', this.buildRequestURI(), true);
        req.onreadystatechange = function() {
          // call callback upon success
          if (typeof callback === 'function' && req.status == 201) {
            callback();
          }
        };
        req.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        req.send(this.toJSONString());
      };
    return BeaconEvent;
    })();

    var bcod = "L51bm1eHv8Mp";
    var completionWindow = 60;

    var counter = 0;
    var beacon = false;
    var player = flowplayer("player", "/lib/flowplayer-3.2.18.swf", {

        plugins: {
            controls: null,
            ima: {
                url: "/lib/flowplayer.ima-3.2.7.swf"
            },
        },
        playlist: [{
            provider: 'ima',
            url: '//b.measuread.com/c2/10181341/vast/c3-c3-1455893410741.xml?c3=9478926&c4=2182016&c5=128816107&DCM_ID=N8485.291800MAGNETICMEDIAONLINE/B9478926.128816107&duration=00:05:23',
            onCuepoint: [[2000], 
            function(clip, cuepoint) { 
                counter += cuepoint;
                if(counter >= completionWindow*1000 && !beacon){
                    // console.log("fl::comp"+completionWindow+"::"+bcod+"::");
                    var beaconEvent = new BeaconEvent("fl::comp"+completionWindow+"::"+bcod+"::");
                    beaconEvent.sendBeacon(function(){});
                    beacon = true;
                }
            }]
        }]
    });
    player.onStart(function(){
        // console.log("fl::start::"+bcod+"::");
        var beaconEvent = new BeaconEvent("fl::start::"+bcod+"::");
        beaconEvent.sendBeacon(function(){});
    });
    player.onFinish(function(){
        // console.log("fl::complete::"+bcod+"::");
        var beaconEvent = new BeaconEvent("fl::complete::"+bcod+"::");
        beaconEvent.sendBeacon(function(){});
    });
    </script>
</body>

</html>